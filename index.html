<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Versement Mobilit√©s - Calculateur de Distance √† Pied</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 40px 20px;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .header {
        margin-bottom: 30px;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 32px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 12px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #667eea;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
      }
      .subtitle {
        color: #718096;
        font-size: 16px;
        line-height: 1.6;
        margin-top: 16px;
      }
      .card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
      }
      .card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 12px;
      }
      .card-subtitle {
        color: #718096;
        font-size: 14px;
        margin-bottom: 16px;
      }
      .card-subtitle a {
        color: #667eea;
        text-decoration: none;
      }
      .card-subtitle a:hover {
        text-decoration: underline;
      }
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 14px;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .info-box {
        background: #bee3f8;
        border-left: 4px solid #3182ce;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      .info-box-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #2c5282;
        margin-bottom: 8px;
      }
      .info-box ul {
        list-style: none;
        padding-left: 0;
      }
      .info-box li {
        color: #2c5282;
        padding-left: 20px;
        position: relative;
        margin-bottom: 4px;
      }
      .info-box li:before {
        content: "‚Ä¢";
        position: absolute;
        left: 8px;
      }
      .upload-zone {
        border: 3px dashed #cbd5e0;
        border-radius: 12px;
        padding: 60px 20px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }
      .upload-zone:hover {
        border-color: #667eea;
        background: #f7fafc;
      }
      .upload-zone.dragover {
        border-color: #667eea;
        background: #edf2f7;
      }
      .upload-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      .upload-title {
        font-size: 20px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
      }
      .upload-subtitle {
        color: #718096;
        font-size: 14px;
      }
      .upload-formats {
        color: #a0aec0;
        font-size: 13px;
        margin-top: 8px;
      }
      input[type="file"] {
        display: none;
      }
      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      button:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }
      .download-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #48bb78;
        color: white;
        padding: 14px 28px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
        margin-left: 12px;
      }
      .download-link:hover {
        background: #38a169;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
      }
      #status {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
      }
      #status:empty {
        display: none;
      }
      #status.success {
        background: #c6f6d5;
        color: #22543d;
        border: 1px solid #9ae6b4;
      }
      #status.error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #fc8181;
      }
      #status.info {
        background: #bee3f8;
        color: #2c5282;
        border: 1px solid #90cdf4;
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 20px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">
          <span>üö∂</span>
          Versement Mobilit√©s - Calculateur de Distance √† Pied
        </h1>
        <div class="badge">
          <span>üêç</span>
          Propuls√© par Python + WebAssembly (Pyodide)
        </div>
        <p class="subtitle">
          Calculez automatiquement les distances √† pied entre deux adresses depuis votre fichier Excel ou CSV
        </p>
      </div>

      <div class="card">
        <h2 class="card-title">
          <span>üîë</span>
          Configuration de la cl√© API Mapbox
        </h2>
        <p class="card-subtitle">
          Obtenez gratuitement votre cl√© API sur 
          <a href="https://account.mapbox.com/" target="_blank" rel="noopener">mapbox.com</a>
          (100 000 requ√™tes/mois gratuites)
        </p>
        <div class="form-group">
          <input 
            id="token" 
            type="text" 
            placeholder="Collez votre cl√© API ici..." 
            autocomplete="off"
          />
        </div>
      </div>

      <div class="info-box">
        <div class="info-box-title">
          <span>üìã</span>
          Format du fichier : Votre fichier doit contenir 2 colonnes :
        </div>
        <ul>
          <li>Colonne A (ou 1√®re colonne) : Adresse de l'entreprise</li>
          <li>Colonne B (ou 2√®me colonne) : Adresse de l'employ√©</li>
        </ul>
      </div>

      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-title">Glissez votre fichier Excel ou CSV ici</div>
        <div class="upload-subtitle">ou cliquez pour s√©lectionner un fichier</div>
        <div class="upload-formats">Formats accept√©s : .xlsx, .xls, .csv</div>
        <input id="file" type="file" accept=".xlsx,.xls,.csv" />
      </div>

      <div class="actions">
        <button id="run" disabled>
          <span>‚è≥</span>
          <span>Charger Pyodide‚Ä¶</span>
        </button>
        <a id="download" style="display:none;" download="enrichi.xlsx" class="download-link">
          <span>üì•</span>
          <span>T√©l√©charger le fichier enrichi</span>
        </a>
      </div>

      <div id="status"></div>
    </div>

    <script type="module">
      const statusEl = document.getElementById("status");
      const runBtn = document.getElementById("run");
      const tokenEl = document.getElementById("token");
      const fileEl = document.getElementById("file");
      const downloadEl = document.getElementById("download");
      const uploadZone = document.getElementById("uploadZone");

      const setStatus = (msg, type = "info") => {
        statusEl.textContent = msg;
        statusEl.className = type;
      };

      // Drag & Drop
      uploadZone.addEventListener("click", () => fileEl.click());
      uploadZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadZone.classList.add("dragover");
      });
      uploadZone.addEventListener("dragleave", () => {
        uploadZone.classList.remove("dragover");
      });
      uploadZone.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          fileEl.files = e.dataTransfer.files;
          const fileName = e.dataTransfer.files[0].name;
          uploadZone.querySelector(".upload-title").textContent = `üìÑ ${fileName}`;
        }
      });

      fileEl.addEventListener("change", () => {
        if (fileEl.files.length) {
          const fileName = fileEl.files[0].name;
          uploadZone.querySelector(".upload-title").textContent = `üìÑ ${fileName}`;
        }
      });

      let pyodide;

      async function init() {
        setStatus("üîß Initialisation de Pyodide...", "info");
        runBtn.querySelector("span:last-child").textContent = "Initialisation...";
        
        pyodide = await loadPyodide();
        setStatus("üì¶ Chargement des packages Python...", "info");
        
        await pyodide.loadPackage(["micropip", "pandas"]);
        await pyodide.runPythonAsync(`
import micropip
await micropip.install('openpyxl')
`);

        await pyodide.runPythonAsync(`
import io
import re
import pandas as pd
from urllib.parse import quote
from pyodide.http import pyfetch

GEOCODING_BASE_URL = "https://api.mapbox.com/search/geocode/v6/forward"
DISTANCE_MATRIX_BASE_URL = "https://api.mapbox.com/directions-matrix/v1/mapbox/walking/"

def _clean_address(address: str) -> str:
    """Supprime les num√©ros d'appartement, escalier, b√¢timent, etc. d'une adresse."""
    if not isinstance(address, str):
        return address
    address = re.sub(r"A(P)*P(AR)*T(EMENT)*\s\d+\s", "", address, flags=re.IGNORECASE)
    address = re.sub(r"ESC(ALIER)*\s*[A-Z0-9]+\s", "", address, flags=re.IGNORECASE)
    address = re.sub(r"BAT\s*[A-Z0-9]+\s", "", address, flags=re.IGNORECASE)
    address = re.sub(r"L(O)*G(T)*\s[A-Z0-9]+\s", "", address, flags=re.IGNORECASE)
    return address.strip()

async def _geocode_one(address: str, token: str):
    url = f"{GEOCODING_BASE_URL}?q={quote(address)}&access_token={quote(token)}"
    r = await pyfetch(url, method="GET")
    if r.status != 200:
        return None
    data = await r.json()
    feats = data.get("features")
    if not feats:
        return None
    lon, lat = feats[0]["geometry"]["coordinates"]
    return float(lon), float(lat)

async def _matrix(coords, token: str):
    """Appel Distance Matrix pour un chunk de coordonn√©es."""
    coords_str = ";".join(f"{lon},{lat}" for lon, lat in coords)
    url = f"{DISTANCE_MATRIX_BASE_URL}{coords_str}?access_token={quote(token)}&annotations=distance,duration"
    r = await pyfetch(url, method="GET")
    r.raise_for_status()
    return await r.json()

async def enrich_excel_bytes(excel_bytes, token: str):
    df = pd.read_excel(io.BytesIO(bytes(excel_bytes)))
    entreprise_col = df.columns[0]
    employe_col = df.columns[1]

    # Nettoyage des adresses
    df_work = df.copy()
    df_work[entreprise_col] = df_work[entreprise_col].astype(str).apply(_clean_address)
    df_work[employe_col] = df_work[employe_col].astype(str).apply(_clean_address)

    # G√©ocodage : r√©cup√©rer toutes les adresses uniques
    addr_series = (
        pd.concat([df_work[entreprise_col], df_work[employe_col]], ignore_index=True)
        .dropna()
        .astype(str)
    )
    addresses = [a for a in pd.unique(addr_series) if a]
    
    # G√©ocoder chaque adresse unique
    geocoded = {}
    for addr in addresses:
        geocoded[addr] = await _geocode_one(addr, token)

    # Mapper les coordonn√©es au DataFrame
    out = df.copy()
    out["Entreprise coords"] = out[entreprise_col].map(geocoded)
    out["Adresse employ√© coords"] = out[employe_col].map(geocoded)

    # Distance matrix par batches manuels (comme dans le notebook)
    out["Distance trajet (m)"] = None
    out["Dur√©e trajet (min)"] = None
    
    batch_size = 12  # Traiter 12 lignes √† la fois
    index_start = 0
    
    while index_start < len(out):
        index_end = min(index_start + batch_size, len(out))
        
        # Construire la liste des coordonn√©es pour ce batch
        batch_coords = []
        batch_coords.extend(out["Adresse employ√© coords"][index_start:index_end].tolist())
        batch_coords.extend(out["Entreprise coords"][index_start:index_end].tolist())
        
        # Filtrer les coordonn√©es nulles
        batch_coords = [c for c in batch_coords if c is not None]
        
        if batch_coords:
            # Appel API Distance Matrix
            matrix = await _matrix(batch_coords, token)
            distances = matrix.get("distances", [])
            durations = matrix.get("durations", [])
            
            # Mapper les distances pour ce batch
            batch_len = index_end - index_start
            for i in range(batch_len):
                emp_index = i
                ent_index = i + batch_len
                
                if emp_index < len(distances) and ent_index < len(distances[emp_index]):
                    distance = distances[emp_index][ent_index]
                    out.at[index_start + i, "Distance trajet (m)"] = distance
                    
                if durations and emp_index < len(durations) and ent_index < len(durations[emp_index]):
                    duration = durations[emp_index][ent_index]
                    out.at[index_start + i, "Dur√©e trajet (min)"] = duration
        
        index_start = index_end

    # Convertir m->km et s->min
    out["Distance trajet (km)"] = out["Distance trajet (m)"].apply(
        lambda m: None if m is None else round(float(m) / 1000, 2)
    )
    out["Dur√©e trajet (min)"] = out["Dur√©e trajet (min)"].apply(
        lambda s: None if s is None else round(float(s) / 60, 1)
    )
    out = out.drop(columns=["Distance trajet (m)"])

    buf = io.BytesIO()
    out.to_excel(buf, index=False)
    return buf.getvalue()
`);

        runBtn.disabled = false;
        runBtn.querySelector("span:first-child").textContent = "üöÄ";
        runBtn.querySelector("span:last-child").textContent = "Enrichir";
        setStatus("‚úÖ Pr√™t √† traiter votre fichier", "success");
      }

      function requireInputs() {
        const token = tokenEl.value.trim();
        const file = fileEl.files?.[0];
        if (!token) throw new Error("‚ö†Ô∏è Cl√© API Mapbox manquante");
        if (!file) throw new Error("‚ö†Ô∏è Fichier Excel/CSV manquant");
        return { token, file };
      }

      async function run() {
        downloadEl.style.display = "none";
        downloadEl.href = "";

        const { token, file } = requireInputs();
        setStatus("üìñ Lecture du fichier...", "info");
        const buf = await file.arrayBuffer();
        const bytes = new Uint8Array(buf);

        setStatus("üåç G√©ocodage des adresses et calcul des distances...", "info");
        pyodide.globals.set("_EXCEL_BYTES", bytes);
        pyodide.globals.set("_TOKEN", token);

        const outBytes = await pyodide.runPythonAsync(`
out = await enrich_excel_bytes(_EXCEL_BYTES, _TOKEN)
out
`);

        let u8;
        if (outBytes instanceof Uint8Array) {
          u8 = outBytes;
        } else if (outBytes && typeof outBytes.toJs === "function") {
          u8 = outBytes.toJs({ create_proxies: false });
          if (!(u8 instanceof Uint8Array)) u8 = new Uint8Array(u8);
          if (typeof outBytes.destroy === "function") outBytes.destroy();
        } else {
          u8 = new Uint8Array(outBytes);
        }
        const blob = new Blob([u8], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        const url = URL.createObjectURL(blob);

        downloadEl.href = url;
        downloadEl.style.display = "inline-flex";
        setStatus("‚úÖ Fichier enrichi pr√™t au t√©l√©chargement", "success");
      }

      runBtn.addEventListener("click", async () => {
        try {
          runBtn.disabled = true;
          runBtn.querySelector("span:first-child").textContent = "‚è≥";
          runBtn.querySelector("span:last-child").textContent = "En cours...";
          await run();
        } catch (e) {
          setStatus(String(e?.message || e), "error");
        } finally {
          runBtn.disabled = false;
          runBtn.querySelector("span:first-child").textContent = "üöÄ";
          runBtn.querySelector("span:last-child").textContent = "Enrichir";
        }
      });

      init().catch((e) => {
        setStatus(String(e?.message || e), "error");
        runBtn.disabled = true;
      });
    </script>
  </body>
</html>
