<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Distance √† Pied - Python WebAssembly</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .api-key-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .api-key-section h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .api-key-section p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .api-key-section a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e8ebff;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .progress-section {
            display: none;
            margin: 30px 0;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .status-text {
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .results-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .error {
            color: #dc3545;
            font-weight: 500;
        }

        .success {
            color: #28a745;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Chargement de Python WebAssembly...</h3>
            <p style="margin-top: 10px; color: #666;">Cela peut prendre quelques secondes</p>
        </div>
    </div>

    <div class="container">
        <h1>üö∂ Calculateur de Distance √† Pied</h1>
        <span class="badge">üêç Propuls√© par Python + WebAssembly (Pyodide)</span>
        <p class="subtitle">Calculez automatiquement les distances √† pied entre deux adresses depuis votre fichier Excel ou CSV</p>

        <div class="api-key-section">
            <h3>üîë Configuration de la cl√© API OpenRouteService</h3>
            <p>Obtenez gratuitement votre cl√© API sur <a href="https://openrouteservice.org/dev/#/signup" target="_blank">openrouteservice.org</a> (2000 requ√™tes/jour gratuites)</p>
            <div class="input-group">
                <input type="password" id="apiKey" placeholder="Collez votre cl√© API ici...">
                <button class="btn btn-primary" onclick="saveApiKey()">Enregistrer</button>
            </div>
            <div id="apiKeyStatus"></div>
        </div>

        <div class="alert alert-info">
            <strong>üìã Format du fichier :</strong> Votre fichier doit contenir 2 colonnes :
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>Colonne A (ou 1√®re colonne) : Adresse de d√©part</li>
                <li>Colonne B (ou 2√®me colonne) : Adresse d'arriv√©e</li>
            </ul>
        </div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <h3>Glissez votre fichier Excel ou CSV ici</h3>
            <p style="margin-top: 10px; color: #666;">ou cliquez pour s√©lectionner un fichier</p>
            <p style="margin-top: 5px; font-size: 0.9em; color: #999;">Formats accept√©s : .xlsx, .xls, .csv</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="status-text" id="statusText">Pr√©paration...</div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>üìä R√©sultats</h2>
            <div class="stats" id="statsContainer"></div>
            <div style="overflow-x: auto;">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Ligne</th>
                            <th>Adresse D√©part</th>
                            <th>Adresse Arriv√©e</th>
                            <th>Distance (km)</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
            <button class="btn btn-primary" onclick="downloadResults()">üì• T√©l√©charger les r√©sultats (Excel)</button>
            <button class="btn btn-secondary" onclick="reset()" style="margin-left: 10px;">üîÑ Nouveau calcul</button>
        </div>
    </div>

    <script>
        let pyodide;
        let apiKey = '';
        let results = [];
        let addresses = [];

        // Initialiser Pyodide au chargement de la page
        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                
                // Charger les packages Python n√©cessaires
                await pyodide.loadPackage(['micropip']);
                
                // Installer les packages Python
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install(['requests', 'urllib3'])
                `);
                
                // D√©finir le code Python pour le calcul des distances
                await pyodide.runPythonAsync(`
import json
import js
from urllib.parse import quote

async def geocode_address(address):
    """G√©ocode une adresse en utilisant Nominatim"""
    try:
        url = f"https://nominatim.openstreetmap.org/search?q={quote(address)}&format=json&limit=1"
        
        # Utiliser fetch de JavaScript
        response = await js.fetch(url, js.Object.new({
            "headers": js.Object.new({
                "User-Agent": "Python-Distance-Calculator-WebAssembly"
            })
        }))
        
        data = await response.json()
        data_list = data.to_py()
        
        if data_list and len(data_list) > 0:
            return {
                'lat': float(data_list[0]['lat']),
                'lon': float(data_list[0]['lon'])
            }
        return None
    except Exception as e:
        print(f"Erreur g√©ocodage: {e}")
        return None

async def calculate_walking_distance(lat1, lon1, lat2, lon2, api_key):
    """Calcule la distance √† pied entre deux coordonn√©es"""
    try:
        url = "https://api.openrouteservice.org/v2/directions/foot-walking"
        
        body = json.dumps({
            "coordinates": [[lon1, lat1], [lon2, lat2]]
        })
        
        response = await js.fetch(url, js.Object.new({
            "method": "POST",
            "headers": js.Object.new({
                "Content-Type": "application/json",
                "Authorization": api_key
            }),
            "body": body
        }))
        
        if response.status != 200:
            return None
            
        data = await response.json()
        data_dict = data.to_py()
        
        distance_meters = data_dict['routes'][0]['summary']['distance']
        return round(distance_meters / 1000, 2)
    except Exception as e:
        print(f"Erreur calcul distance: {e}")
        return None

async def process_address_pair(addr1, addr2, api_key):
    """Traite une paire d'adresses et retourne la distance"""
    # G√©ocodage adresse 1
    coord1 = await geocode_address(addr1)
    if not coord1:
        return {"distance": None, "status": "Erreur g√©ocodage d√©part", "error": True}
    
    # Pause entre les requ√™tes
    await js.sleep(500)
    
    # G√©ocodage adresse 2
    coord2 = await geocode_address(addr2)
    if not coord2:
        return {"distance": None, "status": "Erreur g√©ocodage arriv√©e", "error": True}
    
    # Calcul de la distance
    distance = await calculate_walking_distance(
        coord1['lat'], coord1['lon'],
        coord2['lat'], coord2['lon'],
        api_key
    )
    
    if distance is not None:
        return {"distance": distance, "status": "OK", "error": False}
    else:
        return {"distance": None, "status": "Erreur calcul distance", "error": True}
                `);
                
                console.log('Python WebAssembly initialis√© avec succ√®s');
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Charger la cl√© API du localStorage
                const savedKey = localStorage.getItem('ors_api_key');
                if (savedKey) {
                    apiKey = savedKey;
                    document.getElementById('apiKey').value = savedKey;
                    document.getElementById('apiKeyStatus').innerHTML = '<div style="color: #28a745; margin-top: 10px;">‚úì Cl√© API enregistr√©e</div>';
                }
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de Pyodide:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="loading-content">
                        <h3 style="color: #dc3545;">Erreur de chargement</h3>
                        <p style="margin-top: 10px;">Impossible de charger Python WebAssembly. Veuillez recharger la page.</p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">Recharger</button>
                    </div>
                `;
            }
        }

        // Fonction sleep accessible depuis Python
        window.sleep = function(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        };

        // Initialiser au chargement de la page
        window.onload = initPyodide;

        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('ors_api_key', key);
                document.getElementById('apiKeyStatus').innerHTML = '<div style="color: #28a745; margin-top: 10px;">‚úì Cl√© API enregistr√©e avec succ√®s</div>';
            } else {
                document.getElementById('apiKeyStatus').innerHTML = '<div style="color: #dc3545; margin-top: 10px;">‚úó Veuillez entrer une cl√© API valide</div>';
            }
        }

        // Drag & Drop
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            if (!apiKey) {
                alert('‚ö†Ô∏è Veuillez d\'abord configurer votre cl√© API OpenRouteService');
                return;
            }

            const fileName = file.name.toLowerCase();
            const reader = new FileReader();

            reader.onload = function(e) {
                if (fileName.endsWith('.csv')) {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    addresses = lines.slice(1).map(line => {
                        const cols = line.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                        return cols;
                    }).filter(row => row[0] && row[1]);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    addresses = jsonData.slice(1).filter(row => row[0] && row[1]);
                } else {
                    alert('Format de fichier non support√©. Utilisez .xlsx, .xls ou .csv');
                    return;
                }
                
                if (addresses.length > 0) {
                    startProcessing();
                } else {
                    alert('Aucune donn√©e valide trouv√©e dans le fichier');
                }
            };

            if (fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        async function startProcessing() {
            results = [];
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            for (let i = 0; i < addresses.length; i++) {
                const progress = ((i + 1) / addresses.length * 100).toFixed(0);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBar').textContent = progress + '%';
                document.getElementById('statusText').textContent = `Traitement de la ligne ${i + 1} sur ${addresses.length}... (Python WebAssembly)`;

                const [addr1, addr2] = addresses[i];
                
                try {
                    // Appeler la fonction Python
                    const result = await pyodide.runPythonAsync(`
import asyncio
result = await process_address_pair("${addr1.replace(/"/g, '\\"')}", "${addr2.replace(/"/g, '\\"')}", "${apiKey}")
result
                    `);
                    
                    results.push({
                        row: i + 2,
                        addr1,
                        addr2,
                        distance: result.get('distance'),
                        status: result.get('status'),
                        error: result.get('error')
                    });
                } catch (error) {
                    console.error('Erreur Python:', error);
                    results.push({
                        row: i + 2,
                        addr1,
                        addr2,
                        distance: null,
                        status: 'Erreur traitement',
                        error: true
                    });
                }

                await sleep(1000);
            }

            displayResults();
        }

        function displayResults() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            let successCount = 0;
            let totalDistance = 0;

            results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${result.row}</td>
                    <td>${result.addr1}</td>
                    <td>${result.addr2}</td>
                    <td>${result.distance ? result.distance + ' km' : '-'}</td>
                    <td class="${result.error ? 'error' : 'success'}">${result.status}</td>
                `;

                if (!result.error && result.distance) {
                    successCount++;
                    totalDistance += parseFloat(result.distance);
                }
            });

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.length}</div>
                    <div class="stat-label">Lignes trait√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${successCount}</div>
                    <div class="stat-label">Calculs r√©ussis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDistance.toFixed(2)} km</div>
                    <div class="stat-label">Distance totale</div>
                </div>
            `;
        }

        function downloadResults() {
            const data = [
                ['Ligne', 'Adresse D√©part', 'Adresse Arriv√©e', 'Distance (km)', 'Statut'],
                ...results.map(r => [r.row, r.addr1, r.addr2, r.distance || '', r.status])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'R√©sultats');
            XLSX.writeFile(wb, 'distances_calculees.xlsx');
        }

        function reset() {
            document.getElementById('fileInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            results = [];
            addresses = [];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>